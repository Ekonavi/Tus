name = "cdn3-dev"
main = "src/index.ts"
compatibility_date = "2023-05-10"
compatibility_flags = ["nodejs_compat"]
logpush = true

# Specifies the r2 buckets. r2 bucket names are scoped to your account (not global). The buckets should be publicly inaccessible.
r2_buckets = [
    { binding = "ATTACHMENT_BUCKET", bucket_name = "attachments-dev", preview_bucket_name = "attachments-dev" },
    { binding = "BACKUP_BUCKET", bucket_name = "backups-dev", preview_bucket_name = "backups-dev" }
]

durable_objects.bindings = [
    { name = "ATTACHMENT_UPLOAD_HANDLER", class_name = "AttachmentUploadHandler" },
    { name = "BACKUP_UPLOAD_HANDLER", class_name = "BackupUploadHandler" }
]

[[queues.producers]]
queue = "upload-notification-dev"
binding = "UPLOAD_QUEUE"

# Queue for upload completion notifications

[[migrations]]
tag = "v1"
new_classes = ["UploadHandler"]

[[migrations]]
tag = "v2"
renamed_classes = [{ from = "UploadHandler", to = "AttachmentUploadHandler" }]
new_classes = ["BackupUploadHandler"]

[env.production]
name = "cdn3"

durable_objects.bindings = [
    { name = "ATTACHMENT_UPLOAD_HANDLER", class_name = "AttachmentUploadHandler" },
    { name = "BACKUP_UPLOAD_HANDLER", class_name = "BackupUploadHandler" }
]
r2_buckets = [
    { binding = "ATTACHMENT_BUCKET", bucket_name = "attachments", preview_bucket_name = "attachments" },
    { binding = "BACKUP_BUCKET", bucket_name = "backups", preview_bucket_name = "backups" }
]

[[env.production.queues.producers]]
queue = "upload-notification"
binding = "UPLOAD_QUEUE"


[env.staging]
name = "cdn3-staging"
durable_objects.bindings = [
    { name = "ATTACHMENT_UPLOAD_HANDLER", class_name = "AttachmentUploadHandler" },
    { name = "BACKUP_UPLOAD_HANDLER", class_name = "BackupUploadHandler" }
]
r2_buckets = [
    { binding = "ATTACHMENT_BUCKET", bucket_name = "attachments-staging", preview_bucket_name = "attachments-staging" },
    { binding = "BACKUP_BUCKET", bucket_name = "backups-staging", preview_bucket_name = "backups-staging" }
]

[[env.staging.queues.producers]]
queue = "upload-notification-staging"
binding = "UPLOAD_QUEUE"
